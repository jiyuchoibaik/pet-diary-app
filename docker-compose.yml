# docker-compose.yml (ìˆ˜ì •ëœ ì „ì²´ ì½”ë“œ)

services:
  # 1. MongoDB (ë°ì´í„°ë² ì´ìŠ¤)
  mongodb:
    image: mongo:latest
    container_name: mongodb_container
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    networks:
      - pet_diary_network
    restart: always

  # 2. Redis (ì„¸ì…˜ ê³µìœ  ë° ìºì‹œ)
  redis:
    image: redis:latest
    container_name: redis_container
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - pet_diary_network
    restart: always

  # 3. ì¸ì¦ ì„œë¹„ìŠ¤ (Node.js Express)
  auth-service:
    build:
      context: ./backend-auth
      dockerfile: Dockerfile
    container_name: auth_service_container
    ports:
      - "3001:3001"
    environment:
      PORT: 3001
      MONGO_URI: mongodb://mongodb:27017/auth_db
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - pet_diary_network
    depends_on:
      - mongodb
      - redis
    restart: always

  # 4. ì¼ê¸° ê´€ë¦¬ ì„œë¹„ìŠ¤ (Node.js Express)
  diary-service:
    build:
      context: ./backend-diary
      dockerfile: Dockerfile
    container_name: diary_service_container
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      MONGO_URI: mongodb://mongodb:27017/diary_db
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      # ğŸŒŸ [í•„ìˆ˜ ì¶”ê°€]: í˜¸ìŠ¤íŠ¸ì˜ ./backend-diary/uploadsë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ /app/uploadsì™€ ì—°ê²°
      # ğŸ’¡ Dockerfileì—ì„œ WORKDIRì´ /app/backend-diaryë¼ê³  ê°€ì •í•˜ê±°ë‚˜, ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
      - ./backend-diary/uploads:/app/uploads
    networks:
      - pet_diary_network
    depends_on:
      - mongodb
      - redis
      - auth-service
      # ai-service ì˜ì¡´ì„± ì œê±°
    restart: always


  # 5. í”„ë¡ íŠ¸ì—”ë“œ (React)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_container
    # Nginxê°€ 80ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, í”„ë¡ íŠ¸ì—”ë“œ í¬íŠ¸ëŠ” ì™¸ë¶€ì— ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    networks:
      - pet_diary_network
    restart: always

  # 6. Nginx (ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx_container
    ports:
      - "8080:80"
      - "443:443"
    networks:
      - pet_diary_network
    depends_on:
      - frontend
      - auth-service
      - diary-service
    restart: always 
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf

# Docker ë³¼ë¥¨
volumes:
  mongodb_data:
  redis_data:

# Docker ë„¤íŠ¸ì›Œí¬
networks:
  pet_diary_network:
    driver: bridge