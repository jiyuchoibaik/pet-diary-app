# Nginx worker í”„ë¡œì„¸ìŠ¤ ì„¤ì •
worker_processes auto;

events {
  worker_connections 1024;
}

http {
  # MIME íƒ€ì… ì„¤ì •
  include /etc/nginx/mime.types;
  default_type application/octet-stream;
  resolver 127.0.0.11 valid=10s;


  # Docker Composeì˜ ì„œë¹„ìŠ¤ ì´ë¦„(ì»¨í…Œì´ë„ˆ ì´ë¦„)ì„ ì‚¬ìš©
  # 1. í”„ë¡ íŠ¸ì—”ë“œ (React ì•±)
   upstream frontend_service {
    # 'frontend'ëŠ” docker-compose.ymlì— ì •ì˜ëœ ì„œë¹„ìŠ¤ ì´ë¦„
    # React Dockerfileì—ì„œ 80 í¬íŠ¸ë¥¼ EXPOSE í–ˆìŒ
    server frontend:80; 
  }

  # 2. ì¸ì¦ ì„œë¹„ìŠ¤ (Node.js)
  upstream auth_service {
    # 'auth-service'ëŠ” docker-compose.ymlì— ì •ì˜ëœ ì„œë¹„ìŠ¤ ì´ë¦„
    server auth-service:3001; 
  }

  # 3. ì¼ê¸° ê´€ë¦¬ ì„œë¹„ìŠ¤ (Node.js)
  upstream diary_service {
    server diary-service:3002;
  }


  # ë©”ì¸ ì„œë²„ ë¸”ë¡ (HTTP: 80ë²ˆ í¬íŠ¸)
  server {
    listen 80;

    # (ì„ íƒ) ë¡œê¹… ì„¤ì •
    # access_log /var/log/nginx/access.log;
    # error_log /var/log/nginx/error.log;


    # 1. API - ì¸ì¦ ì„œë¹„ìŠ¤ ë¼ìš°íŒ…
    # http://localhost/api/auth/... ìš”ì²­
    location /api/auth/ {
      proxy_pass http://auth_service/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
    }

    # 2. API - ì¼ê¸° ê´€ë¦¬ ì„œë¹„ìŠ¤ ë¼ìš°íŒ…
    # http://localhost/api/diary/... ìš”ì²­
    location /api/diary/ {
      proxy_pass http://diary_service/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
    }
  
    # 3. ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ (React ì•±ìœ¼ë¡œ ì „ë‹¬)
    # http://localhost/... (/, /mypage, /login ë“±)
    location / {
      proxy_pass http://frontend_service;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
    }

    # ğŸŒŸ [í•µì‹¬ ìˆ˜ì •] ì´ë¯¸ì§€ íŒŒì¼ ìš”ì²­ì„ diary-serviceë¡œ í”„ë¡ì‹œ
    location /uploads/ {
        # diary-service ì»¨í…Œì´ë„ˆ ì´ë¦„ê³¼ í¬íŠ¸ ì‚¬ìš©
        proxy_pass http://diary_service/; 
        # Nginxê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ìºì‹±ì„ ì˜ ì²˜ë¦¬í•˜ë„ë¡ í—¤ë” ì„¤ì • ì¶”ê°€
        proxy_set_header Host $host;
    }
  }
}